
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACO-HABITAT | Diagnostic Toiture Satellite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hero-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .prose { max-width: 100%; color: #4b5563; }
        .prose h3 { margin-top: 1.25em; margin-bottom: 0.5em; font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose li { margin-top: 0.25em; margin-bottom: 0.25em; }
    </style>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "@google/genai": "https://esm.sh/@google/genai@0.1.0"
        }
      }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root"></div>
    <script type="module">
      import React, { useState, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";

      // --- UTILS ---
      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const [header, data] = reader.result.split(',');
          const mimeTypeMatch = header.match(/:(.*?);/);
          if (!data || !mimeTypeMatch) return reject(new Error("Format de fichier invalide."));
          resolve({ mimeType: mimeTypeMatch[1], data });
        };
        reader.onerror = (error) => reject(error);
      });

      // --- GEMINI SERVICE ---
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const model = 'gemini-2.5-flash-image';
      const systemInstruction = `Tu es l'expert n°1 en diagnostic de toiture par imagerie aérienne. Ton but est d'aider un couvreur professionnel à évaluer l'état d'un toit à partir de photos satellites ou de drones.
      Ta mission :
      - Identifier le type de couverture (tuiles, ardoises, zinc, toit plat).
      - Repérer les anomalies : présence de mousse/lichen, tuiles cassées ou manquantes, zones de stagnation d'eau, gouttières obstruées.
      - Évaluer l'usure générale : couleur passée, traces de porosité.
      - Donner un avis sur l'urgence (Faible / Modérée / Haute).
      Ton style : Professionnel, rassurant et technique. Si une zone est floue, précise-le. Structure ta réponse avec des titres clairs en markdown (ex: **Titre**).`;

      const analyzeRoofImage = async (imageData) => {
        try {
          const response = await ai.models.generateContent({
            model,
            contents: { parts: [{ inlineData: imageData }, { text: "Analyse cette toiture et fais-moi un rapport détaillé." }] },
            config: { systemInstruction, temperature: 0.2 },
          });
          if (response.text) return response.text;
          throw new Error("L'analyse n'a pas pu générer de texte.");
        } catch (error) {
          console.error("Error analyzing image:", error);
          throw new Error(`Erreur lors de l'analyse: ${error.message}`);
        }
      };

      // --- UI COMPONENTS ---
      const Loader = () => React.createElement("div", { className: "flex flex-col items-center justify-center p-4" },
        React.createElement("svg", { className: "animate-spin h-8 w-8 text-blue-600", fill: "none", viewBox: "0 0 24 24" },
          React.createElement("circle", { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
          React.createElement("path", { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
        ),
        React.createElement("p", { className: "mt-3 text-sm text-gray-600" }, "Analyse en cours...")
      );
      
      const formatReport = (text) => text.split('\n').map((line, index) => {
          const trimmed = line.trim();
          if (trimmed.length === 0) return null;
          if (trimmed.startsWith('**') && trimmed.endsWith('**')) return React.createElement("h3", { key: index }, trimmed.replace(/\\*\\*/g, ''));
          if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) return React.createElement("li", { key: index, className: "ml-5 list-disc" }, trimmed.substring(2));
          let pClass = "text-gray-700";
          if (trimmed.includes('Urgence : Haute')) pClass = "text-red-600 font-bold";
          if (trimmed.includes('Urgence : Modérée')) pClass = "text-yellow-600 font-bold";
          if (trimmed.includes('Urgence : Faible')) pClass = "text-green-600 font-bold";
          return React.createElement("p", { key: index, className: pClass }, trimmed);
      }).filter(Boolean);

      // --- MAIN APP ---
      const App = () => {
        const [imageUrl, setImageUrl] = useState(null);
        const [imageFile, setImageFile] = useState(null);
        const [report, setReport] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const handleFileChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            setImageFile(file);
            setImageUrl(URL.createObjectURL(file));
            setReport(null); setError(null);
          }
        };

        const handleAnalyze = useCallback(async () => {
          if (!imageFile) return;
          setIsLoading(true); setError(null); setReport(null);
          try {
            const imageData = await fileToBase64(imageFile);
            setReport(await analyzeRoofImage(imageData));
          } catch (err) {
            setError(err.message);
          } finally {
            setIsLoading(false);
          }
        }, [imageFile]);

        const ReportContent = () => {
            if (isLoading) return React.createElement(Loader);
            if (error) return React.createElement("p", { className: "text-red-500 font-semibold" }, `Erreur: ${error}`);
            if (report) return React.createElement("div", { className: "prose" }, formatReport(report));
            return React.createElement("p", { id: "result-text" }, "En attente de votre image pour analyse...");
        };

        return React.createElement("div", null,
          React.createElement("nav", { className: "bg-white shadow-md p-4" },
            React.createElement("div", { className: "container mx-auto flex justify-between items-center" },
              React.createElement("h1", { className: "text-2xl font-bold text-blue-900" }, "ACO-HABITAT"),
              React.createElement("span", { className: "text-sm text-gray-500 hidden md:block" }, "Expertise Toiture par Satellite")
            )
          ),
          React.createElement("header", { className: "hero-gradient text-white py-16 px-4" },
            React.createElement("div", { className: "container mx-auto text-center" },
              React.createElement("h2", { className: "text-4xl md:text-5xl font-extrabold mb-4" }, "Votre bilan toiture en 2 minutes"),
              React.createElement("p", { className: "text-xl opacity-90 mb-8" }, "Analyse haute précision par satellite, sans aucun déplacement.")
            )
          ),
          React.createElement("main", { className: "container mx-auto -mt-10 p-4" },
            React.createElement("div", { className: "bg-white rounded-xl shadow-2xl p-6 md:p-10 max-w-4xl mx-auto" },
              React.createElement("div", { className: "grid md:grid-cols-2 gap-8 items-start" },
                React.createElement("div", null,
                  React.createElement("h3", { className: "text-lg font-semibold mb-4 text-gray-700" }, "1. Localisez votre bien"),
                  React.createElement("input", { type: "text", placeholder: "Adresse complète (optionnel)", className: "w-full p-3 border border-gray-300 rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none" }),
                  React.createElement("h3", { className: "text-lg font-semibold mb-4 text-gray-700" }, "2. Importez la vue satellite"),
                  imageUrl ?
                    React.createElement("div", { className: "relative group" },
                      React.createElement("img", { src: imageUrl, className: "w-full rounded-lg" }),
                      React.createElement("button", { 
                        onClick: () => { setImageUrl(null); setImageFile(null); setReport(null); },
                        className: "absolute top-2 right-2 bg-black bg-opacity-40 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity",
                        "aria-label": "Changer l'image"
                      },
                        React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", className:"h-5 w-5", fill:"none", viewBox:"0 0 24 24", stroke:"currentColor"},
                          React.createElement("path", { strokeLinecap:"round", strokeLinejoin:"round", strokeWidth:2, d:"M6 18L18 6M6 6l12 12" })
                        )
                      )
                    ) :
                    React.createElement("label", { className: "flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100" },
                      React.createElement("div", { className: "flex flex-col items-center justify-center pt-5 pb-6" },
                          React.createElement("svg", { className: "w-8 h-8 mb-3 text-gray-400", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" })),
                          React.createElement("p", { className: "text-sm text-gray-500" }, "Cliquez pour ajouter l'image")
                      ),
                      React.createElement("input", { type: "file", className: "hidden", accept: "image/*", onChange: handleFileChange })
                    ),
                  React.createElement("button", {
                    className: "w-full mt-6 bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-lg shadow-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed",
                    onClick: handleAnalyze,
                    disabled: !imageFile || isLoading
                  },
                    isLoading ? "ANALYSE EN COURS..." : "LANCER L'ANALYSE IA"
                  )
                ),
                React.createElement("div", { className: "bg-blue-50 rounded-lg p-6 border border-blue-100 min-h-[200px]" },
                  React.createElement("h3", { className: "text-lg font-semibold mb-4 text-blue-900 italic underline" }, "Rapport d'expertise :"),
                  React.createElement("div", { className: "space-y-4 text-sm" }, React.createElement(ReportContent))
                )
              )
            )
          ),
          React.createElement("footer", { className: "mt-20 py-8 border-t border-gray-200 text-center text-gray-500 text-sm" },
            "© 2024 ACO-HABITAT - Diagnostics Innovants par Satellite"
          )
        );
      };

      // --- RENDER APP ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    </script>
</body>
</html>
